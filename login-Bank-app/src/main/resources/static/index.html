<script>
    const BASE_URL = "https://spring-boot-app-fl4i.onrender.com/Bank";

    function getToken() {
      return localStorage.getItem("jwtToken");
    }

    function authHeader() {
      const token = getToken();
      if (!token) {
        alert("Please login first!");
        throw new Error("No JWT token found");
      }
      return { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" };
    }

    async function parseResponse(res) {
      const contentType = res.headers.get("content-type");
      if (!res.ok) {
        return { status: "error", message: `HTTP ${res.status}` };
      }
      if (contentType && contentType.includes("application/json")) {
        return res.json();
      } else {
        const text = await res.text();
        return { status: "success", message: text || "No content" };
      }
    }

    async function signup() {
      const name = document.getElementById("signupName").value;
      const mobile = document.getElementById("signupMobile").value;
      const password = document.getElementById("signupPassword").value;

      try {
        const res = await fetch(`${BASE_URL}/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, mobile, password })
        });
        const result = await parseResponse(res);
        document.getElementById("signupMsg").innerText = result.message;
        document.getElementById("signupMsg").className = result.status === "success" ? "success" : "error";
      } catch {
        document.getElementById("signupMsg").innerText = "Signup Failed!";
        document.getElementById("signupMsg").className = "error";
      }
    }

    async function login() {
      const mobile = document.getElementById("loginMobile").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch(`${BASE_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobile, password })
      });

      const result = await parseResponse(res);
      if (result.status === "success") {
        localStorage.setItem("jwtToken", result.data);
        document.getElementById("loginMsg").innerText = result.message;
        document.getElementById("loginMsg").className = "success";
        showMain();
      } else {
        document.getElementById("loginMsg").innerText = result.message;
        document.getElementById("loginMsg").className = "error";
      }
    }

    async function balance() {
      try {
        const res = await fetch(`${BASE_URL}/balance`, {
          headers: authHeader()
        });
        const result = await parseResponse(res);
        document.getElementById("response").innerText = result.message + (result.data ? "\nBalance: " + result.data : "");
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    async function deposit() {
      const amount = document.getElementById("amount").value;
      try {
        const res = await fetch(`${BASE_URL}/deposit/${amount}`, {
          method: "PUT",
          headers: authHeader()
        });
        const result = await parseResponse(res);
        document.getElementById("response").innerText = result.message;
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    async function withdraw() {
      const amount = document.getElementById("amount").value;
      try {
        const res = await fetch(`${BASE_URL}/withdraw/${amount}`, {
          method: "PUT",
          headers: authHeader()
        });
        const result = await parseResponse(res);
        document.getElementById("response").innerText = result.message;
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    async function sendMoney() {
      const receiver = document.getElementById("receiver").value;
      const amount = document.getElementById("sendAmount").value;
      try {
        const res = await fetch(`${BASE_URL}/send/${receiver}/${amount}`, {
          method: "PUT",
          headers: authHeader()
        });
        const result = await parseResponse(res);
        document.getElementById("response").innerText = result.message;
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    async function transactionHistory() {
      try {
        const res = await fetch(`${BASE_URL}/history`, {
          headers: authHeader()
        });
        const result = await parseResponse(res);
        if (result.status === "success" && Array.isArray(result.data)) {
          let history = "Transaction History:\n";
          result.data.forEach(tx => {
            history += `Type: ${tx.type}, Amount: ${tx.amount}, From: ${tx.from}, Time: ${tx.timestamp}\n`;
          });
          document.getElementById("response").innerText = history;
        } else {
          document.getElementById("response").innerText = result.message;
        }
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    async function deleteAccount() {
      try {
        const res = await fetch(`${BASE_URL}/delete`, {
          method: "DELETE",
          headers: authHeader()
        });
        const result = await parseResponse(res);
        document.getElementById("response").innerText = result.message;
      } catch (e) {
        document.getElementById("response").innerText = "Error: " + e.message;
      }
    }

    function logout() {
      localStorage.removeItem("jwtToken");
      document.getElementById("mainPage").classList.add("hidden");
      document.getElementById("authPage").classList.remove("hidden");
      document.getElementById("loginMsg").innerText = "Logged out!";
      document.getElementById("loginMsg").className = "";
    }

    function showMain() {
      document.getElementById("authPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
    }
</script>
